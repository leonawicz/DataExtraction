<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="Matthew Leonawicz" />


<title>Minimal Empirical Density Estimation</title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/united.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>
<style type="text/css">
/* padding for bootstrap navbar */
body {
padding-top: 50px;
padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar) */
.section h2 {
padding-top: 55px;
margin-top: -55px;
}
.section h3 {
padding-top: 55px;
margin-top: -55px;
}
/* don't use link color in navbar */
.dropdown-menu>li>a {
color: black;
}
/* some padding for disqus */
#disqus_thread {
margin-top: 45px;
}
p {
  text-align: justify;
}
img.centered {
  display: block;
  margin-left: auto;
  margin-right: auto;
}
</style>
<link rel="stylesheet" href="libs/font-awesome-4.1.0/css/font-awesome.min.css"/>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #303030; color: #cccccc; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; }
td.sourceCode { padding-left: 5px; }
pre, code { color: #cccccc; background-color: #303030; }
code > span.kw { color: #f0dfaf; }
code > span.dt { color: #dfdfbf; }
code > span.dv { color: #dcdccc; }
code > span.bn { color: #dca3a3; }
code > span.fl { color: #c0bed1; }
code > span.ch { color: #dca3a3; }
code > span.st { color: #cc9393; }
code > span.co { color: #7f9f7f; }
code > span.ot { color: #efef8f; }
code > span.al { color: #ffcfaf; }
code > span.fu { color: #efef8f; }
code > span.er { color: #c3bf9f; }
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46129458-3', 'auto');
  ga('send', 'pageview');

</script>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">

<div class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Data Extraction</a>
      </div>
      <div class="navbar-collapse collapse navbar-responsive-collapse">
        <ul class="nav navbar-nav">
          <li class="dropdown">
            <a href="extraction-evaluation" class="dropdown-toggle" data-toggle="dropdown">Extraction evaluation <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Project</li>
              <li><a href="eval_intro.html">Introduction</a></li>
              <li><a href="eval_case.html">Case study: sample mean</a></li>
              <li><a href="eval_res.html">Results</a></li>
              <li><a href="eval_next.html">Next steps</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">R Code</li>
              <li><a href="extract_eval_code.html">Complete code</a></li>
            </ul>

          <li class="dropdown">
            <a href="density-estimation" class="dropdown-toggle" data-toggle="dropdown">Density estimation <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Project</li>
              <li><a href="dens_intro.html">Introduction</a></li>
              <li><a href="dens_sims.html">Simulations</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Use cases</li>
              <li><a href="dens_use1.html">Case 1: Climate</a></li>
              <li><a href="dens_use2.html">Case 2: Vegetation</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">R code</li>
              <li><a href="dens_sims_code.html">Basic simulation</a></li>
            </ul>

          <li class="dropdown">
            <a href="pre-indexing" class="dropdown-toggle" data-toggle="dropdown">Pre-indexing <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Project</li>
              <li><a href="ind_intro.html">Introduction</a></li>
              <li><a href="ind_related.html">Related items</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">R Code</li>
              <li><a href="ind_code.html">Complete code</a></li>
            </ul>

          <li><a href="http://leonawicz.github.io">All Projects</a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <a class="btn btn-link" href="https://github.com/leonawicz/DataExtraction">
            <i class="fa fa-github fa-lg"></i>
            Github
          </a>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </div>

<div id="header">
<h1 class="title">Minimal Empirical Density Estimation</h1>
<h4 class="author"><em>Matthew Leonawicz</em></h4>
</div>


<div id="use-case-1-climate" class="section level2">
<h2>Use case 1: Climate</h2>
<p>Temperature and precipition data from SNAPâ€™s downscaled climate models are often used to make inferences about future trends and uncertainty among potential climate scenarios. This generally is done by looking at specific statistics culled from the model outputs, usually the mean value over some combination of factors of interest such as seasonal period or geographical region. But what about when we want to look at an entire distribution of data at once? Furthermore, we want to visualize many distributions in quick succession, distributions of temperature or precipitation from different months, seasons, years, decades, locations, climate models, scenarios, etc.</p>
<p>This is a case where I extract a relatively coarse density estimate a priori. Subsequently, this small, stored estimate, is what is actually used to regenerate an accurate simulation of the original model output. This means no inefficient, slow lugging around of big data. Compress it down, release it in similar to original form later.</p>
<p>The following is used in the <code>AR4_AR5_extract.R</code> script which is part of the SNAP data QA/QC project and feeds into the Shiny app for comparing CMIP3 and CMIP5 downscaled climate model outputs. There is a function for estimating densities. In this case I wanted to avoid any <code>NA</code> values and for precipitation I wanted to ensure densities did not include positive probability over any interval containing negative values. The only other variable being analyzed was temperature. Things like this are important to code for in nuanced ways when the goal is to apply such a function to a large number of datasets. Effort must go into dealing with rare idiosyncrasies in the data and their effects.</p>
<pre class="sourceCode r"><code class="sourceCode r">denFun &lt;-<span class="st"> </span>function(x, n, variable) {
    x &lt;-<span class="st"> </span>x[!<span class="kw">is.na</span>(x)]
    dif &lt;-<span class="st"> </span><span class="kw">diff</span>(<span class="kw">range</span>(x))
    z &lt;-<span class="st"> </span><span class="kw">density</span>(x, <span class="dt">adjust =</span> <span class="dv">2</span>, <span class="dt">n =</span> n, <span class="dt">from =</span> <span class="kw">min</span>(x) -<span class="st"> </span><span class="fl">0.05</span> *<span class="st"> </span>dif, <span class="dt">to =</span> <span class="kw">max</span>(x) +<span class="st"> </span>
<span class="st">        </span><span class="fl">0.05</span> *<span class="st"> </span>dif)
    if (variable ==<span class="st"> &quot;pr&quot;</span> &amp;&amp;<span class="st"> </span><span class="kw">any</span>(z$x &lt;<span class="st"> </span><span class="dv">0</span>)) 
        z &lt;-<span class="st"> </span><span class="kw">density</span>(x, <span class="dt">adjust =</span> <span class="dv">2</span>, <span class="dt">n =</span> n, <span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="kw">max</span>(x) +<span class="st"> </span><span class="fl">0.05</span> *<span class="st"> </span>dif)
    <span class="kw">as.numeric</span>(<span class="kw">c</span>(z$x, z$y))
}</code></pre>
<p>On the other end, in this case tucked within the aforementioned Shiny app, the function, <code>density2bootstrap</code> is used to simulate new draws from the estimated density. This is much faster and more efficient than trying to load an enormous data set. In this app, the <code>ggplo2</code> graphics rely on the sample for plotting which is why the bootstrapping occurs following loading of the density estimate, and why there is no subsequent code for fitting a new density estimate to the bootstrap sample.</p>
<pre class="sourceCode r"><code class="sourceCode r">density2bootstrap &lt;-<span class="st"> </span>function(d, n.density, <span class="dt">n.boot =</span> <span class="dv">10000</span>, <span class="dt">interp =</span> <span class="ot">FALSE</span>, 
    <span class="dt">n.interp =</span> <span class="dv">1000</span>, ...) {
    n.fact &lt;-<span class="st"> </span>n.boot/n.density
    n.grp &lt;-<span class="st"> </span><span class="kw">nrow</span>(d)/n.density
    d$Index &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>:n.grp, <span class="dt">each =</span> n.density)
    d2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">lapply</span>(d, rep, n.fact), <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)
    prob.col &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">names</span>(d2) %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Prob&quot;</span>, <span class="st">&quot;Index&quot;</span>))
    d2 &lt;-<span class="st"> </span>d2[<span class="kw">order</span>(d2$Index), -prob.col]
    d2$Val &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">vapply</span>(<span class="dt">X =</span> <span class="dv">1</span>:n.grp, <span class="dt">FUN =</span> function(i, d, n, interp, 
        n.interp, ...) {
        p &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">x =</span> d$Val[d$Index ==<span class="st"> </span>i], <span class="dt">y =</span> d$Prob[d$Index ==<span class="st"> </span>i])
        if (interp) p &lt;-<span class="st"> </span><span class="kw">approx</span>(p$x, p$y, <span class="dt">n =</span> n.interp)
        <span class="kw">round</span>(<span class="kw">sample</span>(p$x, n, <span class="dt">prob =</span> p$y, <span class="dt">rep =</span> T), ...)
    }, <span class="dt">FUN.VALUE =</span> <span class="kw">numeric</span>(n.boot), <span class="dt">d =</span> d, <span class="dt">n =</span> n.boot, <span class="dt">interp =</span> interp, <span class="dt">n.interp =</span> n.interp, 
        ...))
    d2
}</code></pre>
<p>However, for a complete picture of how these functions work together, it is important to see the documentation for the projects of which they are a part.</p>
</div>

<!-- some extra javascript for older browsers -->
<script type="text/javascript" src="libs/polyfill.js"></script>
<script>
  // manage active state of menu based on current page
  $(document).ready(function () {
  
    // active menu
    href = window.location.pathname
    href = href.substr(href.lastIndexOf('/') + 1)
    $('a[href="' + href + '"]').parent().addClass('active');
    
    // manage active menu header
    if (href.startsWith('authoring_'))
      $('a[href="' + 'authoring' + '"]').parent().addClass('active');
    else if (href.endsWith('_format.html'))
      $('a[href="' + 'formats' + '"]').parent().addClass('active');
    else if (href.startsWith('developer_'))
      $('a[href="' + 'developer' + '"]').parent().addClass('active');
	  
  });
</script>

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>


</body>
</html>
